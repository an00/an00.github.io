<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="chenzuoqing">
    
    <title>
        
            mysql MHA 记录 |
        
        PIAOMIAO神经
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/img/IMG_0001.JPG">
    
    
<link rel="stylesheet" href="/font/css/fontawesome.min.css">

    
<link rel="stylesheet" href="/font/css/regular.min.css">

    
<link rel="stylesheet" href="/font/css/solid.min.css">

    
<link rel="stylesheet" href="/font/css/brands.min.css">

    
        
            
                
<link rel="stylesheet" href="/css/custom.css">

            
        
    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"blog.an00.cn","root":"/","language":"en","path":"search.json"}
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true,"layout":"right"},"style":{"primary_color":"#0066cc","logo":"/img/IMG_0001.JPG","favicon":"/img/IMG_0001.JPG","avatar":"/img/IMG_0001.JPG","first_screen":{"enable":true,"header_transparent":false,"background_img":"/images/bg.svg","description":"道阻且长，行则将至。","hitokoto":false},"scroll":{"progress_bar":true,"percent":true}},"local_search":{"enable":true,"preload":false},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"default"},"pjax":{},"lazyload":{"enable":true},"comment":{},"post":{"author_label":{"enable":true,"auto":true,"custom_label_list":["Trainee","Engineer","Architect"]},"word_count":{"wordcount":false,"min2read":false},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":true,"share":true,"reward":{"enable":false,"img_link":null,"text":null}},"website_count":{"busuanzi_count":{"enable":true,"site_uv":true,"site_pv":true,"page_pv":true}},"version":"3.8.6"}
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"}
    KEEP.language_code_block = {"copy":"Copy code","copied":"Copied","fold":"Fold code block","folded":"Folded"}
    KEEP.language_copy_copyright = {"copy":"Copy copyright info","copied":"Copied","title":"Original article title","author":"Original article author","link":"Original article link"}
  </script>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="An00" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
</div>


<main class="page-container border-box">

    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/img/IMG_0001.JPG">
                </a>
            
            <a class="site-name border-box" href="/">
               PIAOMIAO神经
            </a>
        </div>

        <div class="right border-box">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                CATEGORIES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                TAGS
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                ABOUT
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">ARCHIVES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">CATEGORIES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">TAGS</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">ABOUT</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">

                

                    <div class="fade-in-down-animation">
    <div class="post-page-container border-box">

        <div class="article-content-container border-box">

            

            <div class="article-content-bottom border-box">
                
                    <div class="article-title">
                        mysql MHA 记录
                    </div>
                

                
                    <div class="article-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/img/IMG_0001.JPG">
                            </div>
                        
                        <div class="info-box">
                            <div class="author">
                                <span class="name">chenzuoqing</span>
                                
                                    <span class="author-label">Lv3</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="article-meta-info-container border-box post">
    <div class="article-meta-info border-box">
        


        
            <span class="meta-info-item article-create-date">
                <i class="icon fa-solid fa-calendar-check"></i>&nbsp;
                <span class="pc">2018-03-13 10:57:54</span>
                <span class="mobile">2018-03-13 10:57</span>
            </span>

            <span class="meta-info-item article-update-date">
                <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                <span class="pc" data-updated="Sun Oct 29 2023 15:04:42 GMT+0800">2023-10-29 15:04:42</span>
            </span>
        

        
            <span class="meta-info-item article-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="article-category-ul">
                    
                            <li class="category-item"><a href="/categories/MySQL/">MySQL</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="article-tag meta-info-item border-box">
                <i class="icon fas fa-tags"></i>&nbsp;
                <ul class="article-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/MHA/">MHA</a></li>
                        
                    
                </ul>
            </span>
        

        
        
        
        
            <span class="meta-info-item article-pv">
                <i class="icon fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
            </span>
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="article-content keep-markdown-body">
                    

                    <h1 id="MySQL-MHA配置记录"><a href="#MySQL-MHA配置记录" class="headerlink" title="MySQL MHA配置记录"></a>MySQL MHA配置记录</h1><h2 id="MHA介绍"><a href="#MHA介绍" class="headerlink" title="MHA介绍"></a>MHA介绍</h2><p>MHA是一套 MySQL 高可用管理软件 ，除了检测 Master 宕机后，提升候选 Slave 为 New Master 之外，还会自动让其他 Slave 与 New Master 建立复制关系。切换通过浮动 ip 的方式，浮动 ip 将绑定在任何时期的主节点上（若切换则 ip 也漂移），通过浮动 ip 提供服务。</p>
<p><code>MHA Manager</code>可以 单独部署在一台独立的机器上，并管理多个 <code>master-slave</code> 集群，只需要指定不通的配置文件。  </p>
<span id="more"></span>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">-- </span><br><span class="line">+------------------------------------+ (app1.conf) +----------+</span><br><span class="line">|                           VIP      |   heartbeat |    MHA   |</span><br><span class="line">|  +----------+    rpl   +--------+  &lt;-------------+  Manager |</span><br><span class="line">|  | Slave(M) +----------&gt; Master |  | rpl manager +----------+</span><br><span class="line">|  +----------+          +-^----^-+  |                  |</span><br><span class="line">|                  rpl     |    |    |                  |</span><br><span class="line">|       +------------------+    |rpl |                  |</span><br><span class="line">|       |                       |    |      (app2.conf) |</span><br><span class="line">|  +---------+           +-------+-+ |             +----V----+</span><br><span class="line">|  | Slave 1 |  ......   | Slave N | |             |  Other  |</span><br><span class="line">|  +---------+           +---------+ |             |  MySQL  |</span><br><span class="line">|                                    |             |   rpl   |</span><br><span class="line">|             MySQL Replication      |             +---------+</span><br><span class="line">+------------------------------------+</span><br></pre></td></tr></table></figure>

<h3 id="集群节点描述"><a href="#集群节点描述" class="headerlink" title="集群节点描述"></a>集群节点描述</h3><ol>
<li><strong>MHA Manager</strong>： MHA的管理节点，负责检测MySQL的状态，以及管理MySQL的复制关系</li>
<li><strong>Master</strong>： MySQL对外提供的服务（ 通过 VIP ）的主节点</li>
<li>**Slave(M)**： MySQL候选主节点，本质上为一个Slave节点，只是在Master宕机后，会被提升为 New Master </li>
<li><strong>Slave N</strong>： MySQL从机节点，对外可以提供只读服务</li>
</ol>
<h3 id="故障检测过程"><a href="#故障检测过程" class="headerlink" title="故障检测过程"></a>故障检测过程</h3><p>&emsp;&emsp;当Master宕机后，<code>MHA Manager</code>会让 Slave(M) 提升为 New Master，然后修改 Slave(N) 的复制关系（<code>CHANGE MASTER</code>），指向 New Master</p>
<ol>
<li><code>MHA Manager</code>检测Master是否宕机，不会简单的只检查自身与Master之间的直连状态</li>
<li><code>MHA Manager</code>会 透过其他Slave节点去检测Master，进行二次探测，最大限度的避免脑裂的发生</li>
<li>若检测到Master宕机了， <code>MHA Manager</code>会 透过Slave(M) 检测是否为宕机；如果检测后仍为宕机状态，会继续 透过Slave1…SlaveN进行探测，只有在透过所有节点检测到Master宕机了，才真的认为Master宕机了。</li>
</ol>
<ul>
<li>以上操作步骤的前提是，**<code>MHA Manager</code> 到所有 MySQL 节点的 SSH 免密码登录要打通**。<br>最后将提供对外服务的 VIP 漂移到 New Master 上，继续对外提供服务。</li>
</ul>
<h3 id="MHA-Failover过程"><a href="#MHA-Failover过程" class="headerlink" title="MHA Failover过程"></a><strong>MHA Failover过程</strong></h3><ol>
<li>从宕机崩溃的 Master 节点 保存二进制日志事件（<code>binlog events</code>）<ul>
<li>此种情况为 MySQL 挂了，但是服务器没挂 ，还是可以通过 SSH 连接过去</li>
<li>如果服务器彻底宕机了，该步骤略过</li>
</ul>
</li>
<li>识别 含有最新的更新 的 Slave 节点</li>
<li>应用差异的中继日志 （ <code>relay-log</code>）到其他的 Slave</li>
<li>应用从 Master 保存的二进制日志事件（<code>binlog events</code>）<ul>
<li>如果之前 Master 彻底宕机了，就没有保存的 binlog，该步骤略过</li>
</ul>
</li>
<li>提升一个 Slave 为新的 Master（ New）  </li>
<li>使其他的 Slave 连接新的 Master（ New） 进行复制</li>
</ol>
<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>&emsp;&emsp;从上面的步骤看， <strong>MHA本身无法完全保证数据不会丢</strong>  </p>
<ol>
<li>MySQL 5.7 之前数据不丢的前提是 Master 服务器还可以被 <code>MHA Manager</code> 进行 SSH 连接 ，通过 应用保存的<code>binlog</code>的方式来保证。  </li>
<li>MySQL 5.7 之后通过无损复制，仅仅是减少了丢数据的可能性，假如此时的状态为切成异步的状态 ，那就和之前一样了（<strong>可以设置超时的时间很大</strong>）。  </li>
<li>当 <code>Master </code>恢复的时候，最后一部分数据是否需要 <code>Flashback</code>， MHA 不负责这个操作，需要人工确认。</li>
</ol>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><blockquote>
<p>会用到 <code>mysql utilities </code>中的工具，请安装。  </p>
</blockquote>
<h3 id="测试集群拓扑图"><a href="#测试集群拓扑图" class="headerlink" title="测试集群拓扑图"></a>测试集群拓扑图</h3><p>&emsp;&emsp;注意： slave 中的 <code>/etc/my.cnf</code> 中需要配置 <code>report-host=slave ip_addr</code> ，否则命令执行失败。  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; mysqlrplshow --master=root:111111@&quot;192.168.122.66:3307&quot; --discover-slaves-login=root:111111 -r -v</span><br><span class="line">WARNING: Using a password on the command line interface can be insecure.</span><br><span class="line"># master on 192.168.122.66: ... connected.</span><br><span class="line"># Finding slaves for master: 192.168.122.66:3307</span><br><span class="line"># master on 192.168.122.70: ... connected.</span><br><span class="line"># Finding slaves for master: 192.168.122.70:3307</span><br><span class="line"></span><br><span class="line">WARNING: Cannot connect to some slaves:</span><br><span class="line"> - 192.168.122.70:3306: Can&#x27;t connect to MySQL server on &#x27;192.168.122.70:3306&#x27; (111 Connection refused)</span><br><span class="line"># master on 192.168.122.80: ... connected.</span><br><span class="line"># Finding slaves for master: 192.168.122.80:3307</span><br><span class="line"></span><br><span class="line"># Replication Topology Graph</span><br><span class="line">192.168.122.66:3307 (MASTER)  [由于机器数量问题，此节点会跑MHA manager和node]</span><br><span class="line">   |</span><br><span class="line">   +--- 192.168.122.70:3307 [IO: Yes, SQL: Yes] - (SLAVE)  [做MHA node]</span><br><span class="line">   |</span><br><span class="line">   +--- 192.168.122.80:3307 [IO: Yes, SQL: Yes] - (SLAVE)  [做MHA node]</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;另外如果使用 <code>mysqlreplicate</code> 创建复制关系，则他会帮你在你的 <code>Master</code>上创建 <code>rpl@192.168.122.70</code> ， <code>rpl@192.168.122.80</code> 用户，需要注意这个 <code>rpl</code> 用户需要赋予 <code>replication</code>和<code>slave</code> 权限，可以手动确认一下。</p>
<h3 id="MHA软件角色分布"><a href="#MHA软件角色分布" class="headerlink" title="MHA软件角色分布"></a>MHA软件角色分布</h3><p>&emsp;&emsp;上述架构，MHA 中 <code>Manager</code> 节点最好不要在集群中(这里空闲的测试机有限，so..，需要打通 <code>Manager</code> 节点到所有 mysql 节点的 ssh 密钥连接，mysql 节点相互也需要打通，方便无密码登陆。操作不演示。 </p>
<h2 id="安装MHA软件"><a href="#安装MHA软件" class="headerlink" title="安装MHA软件"></a>安装MHA软件</h2><blockquote>
<p>示例基于1主2从，需要先搭建好，打通 ssh 认证。<br>MHA Node 在所有节点上都要安装  </p>
</blockquote>
<h3 id="获取MHA源码"><a href="#获取MHA源码" class="headerlink" title="获取MHA源码"></a>获取MHA源码</h3><p>&emsp;&emsp;获取MHA源码，github中tar包最新的貌似是 0.56 <a class="link"   target="_blank" rel="noopener" href="https://github.com/yoshinorim/mha4mysql-manager/wiki/Downloads" >下载地址<i class="fas fa-external-link-alt"></i></a>，rpm 包有 0.57 <a class="link"   target="_blank" rel="noopener" href="https://github.com/linyue515/mysql-master-ha" >下载地址<i class="fas fa-external-link-alt"></i></a>，需要源码版可以往百度云找，已收藏…<br>PS：有梯子可以打开 <a class="link"   target="_blank" rel="noopener" href="https://mega.nz/#F!G4oRjARB!SWzFS59bUv9VrKwdAeIGVw" >此处下载0.57<i class="fas fa-external-link-alt"></i></a></p>
<h3 id="如上准备主从，mysqlreplicate搭建，不演示。"><a href="#如上准备主从，mysqlreplicate搭建，不演示。" class="headerlink" title="如上准备主从，mysqlreplicate搭建，不演示。"></a>如上准备主从，mysqlreplicate搭建，不演示。</h3><h3 id="安装依赖包"><a href="#安装依赖包" class="headerlink" title="安装依赖包"></a>安装依赖包</h3><p>安装 <code>perl</code> 依赖包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-- redhat系安装依赖，若装完执行makefile报错可以尝试重新登陆下</span><br><span class="line">yum install perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch perl-Parallel-ForkManager perl-Time-HiRes \</span><br><span class="line">    perl-ExtUtils-CBuilder perl-ExtUtils-MakeMaker perl-ExtUtils-Embed cpan perl-CPAN</span><br><span class="line">   </span><br><span class="line">-- debian系安装依赖</span><br><span class="line">apt install libdbd-mysql-perl libconfig-tiny-perl liblog-dispatch-perl libparallel-forkmanager-perl</span><br><span class="line">   </span><br></pre></td></tr></table></figure>

<h3 id="安装MHA-Manager"><a href="#安装MHA-Manager" class="headerlink" title="安装MHA Manager"></a>安装MHA Manager</h3><p><code>mysql master</code> 节点安装 mha node 和 manager，先解压好（这里环境的 <code>MHA Manager</code> 放在了 mysql 节点中）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">shell&gt; </span><span class="language-bash"><span class="built_in">cd</span> mha4mysql-manager-0.57</span></span><br><span class="line"><span class="meta prompt_">shell&gt; </span><span class="language-bash">perl Makefile.PL</span></span><br><span class="line"><span class="meta prompt_">shell&gt; </span><span class="language-bash">make &amp;&amp; make install</span></span><br><span class="line"><span class="meta prompt_">shell&gt; </span><span class="language-bash">ll bin/</span></span><br><span class="line">total 40</span><br><span class="line">-rwxr-xr-x 1 git mysql 1995 May 31  2015 masterha_check_repl         # 检查MySQL复制状态</span><br><span class="line">-rwxr-xr-x 1 git mysql 1779 May 31  2015 masterha_check_ssh          # 检查MHA的SSH状态</span><br><span class="line">-rwxr-xr-x 1 git mysql 1865 May 31  2015 masterha_check_status       # 检查当前MHA的状态</span><br><span class="line">-rwxr-xr-x 1 git mysql 3201 May 31  2015 masterha_conf_host          # 添加或删除配置的server信息</span><br><span class="line">-rwxr-xr-x 1 git mysql 2517 May 31  2015 masterha_manager            # 启动MHA</span><br><span class="line">-rwxr-xr-x 1 git mysql 2165 May 31  2015 masterha_master_monitor     # 检测master是否宕机</span><br><span class="line">-rwxr-xr-x 1 git mysql 2373 May 31  2015 masterha_master_switch      # 控制故障转移（手动或者自动）</span><br><span class="line">-rwxr-xr-x 1 git mysql 5171 May 31  2015 masterha_secondary_check    # 通过slave检测master是否宕机（二次探测）</span><br><span class="line">-rwxr-xr-x 1 git mysql 1739 May 31  2015 masterha_stop               # MHA停止</span><br><span class="line"><span class="meta prompt_">shell&gt; </span><span class="language-bash"><span class="built_in">mkdir</span> -p /etc/masterha          <span class="comment"># MHA配置文件存放目录</span></span></span><br><span class="line"><span class="meta prompt_">shell&gt; </span><span class="language-bash"><span class="built_in">mkdir</span> -p /var/log/masterha/app1 <span class="comment"># 建议和MHA配置文件保持一致，若管理多套mysql集群可以再新建appxxx</span></span></span><br><span class="line"><span class="meta prompt_">shell&gt; </span><span class="language-bash"><span class="built_in">mkdir</span> -p /usr/local/mha/        <span class="comment"># 准备存放MHA可执行程序和lib</span></span></span><br><span class="line"><span class="meta prompt_">shell&gt; </span><span class="language-bash"><span class="built_in">cp</span> -rf bin/ lib/ /usr/local/mha/</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">shell&gt; </span><span class="language-bash"><span class="built_in">cd</span> ../mha4mysql-node-0.57/      <span class="comment"># manager也需要安装node工具</span></span></span><br><span class="line"><span class="meta prompt_">shell&gt; </span><span class="language-bash">perl Makefile.PL</span></span><br><span class="line"><span class="meta prompt_">shell&gt; </span><span class="language-bash">make &amp;&amp; make install</span></span><br><span class="line"><span class="meta prompt_">shell&gt; </span><span class="language-bash"><span class="built_in">cp</span> bin/* /usr/local/mha/bin/</span></span><br><span class="line"><span class="meta prompt_">shell&gt; </span><span class="language-bash"><span class="built_in">cp</span> lib/* /usr/local/mha/lib/</span> </span><br></pre></td></tr></table></figure>

<h3 id="安装MHA-node"><a href="#安装MHA-node" class="headerlink" title="安装MHA node"></a>安装MHA node</h3><p>为所有节点安装 <code>MHA node</code>，这里两个 slave 只安装 mha node</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; yum install perl-DBI perl-DBD-MySQL -y   # node节点依赖较少</span><br><span class="line">shell&gt; cd mha4mysql-node-0.57/</span><br><span class="line">shell&gt; perl Makefile.PL</span><br><span class="line">shell&gt; make &amp;&amp; make install</span><br><span class="line">shell&gt; ll bin/</span><br><span class="line">total 44</span><br><span class="line">-rwxr-xr-x 1 1001 mysql 16381 May 31  2015 apply_diff_relay_logs  # 识别差异的中继日志事件并将其差异的事件应用于其他的slave</span><br><span class="line">-rwxr-xr-x 1 1001 mysql  4807 May 31  2015 filter_mysqlbinlog     # 去除不必要的ROLLBACK事件（脚本中指出该脚本已经过时，应该是被废弃了）</span><br><span class="line">-rwxr-xr-x 1 1001 mysql  8261 May 31  2015 purge_relay_logs       # 清除中继日志（不会阻塞SQL线程）</span><br><span class="line">-rwxr-xr-x 1 1001 mysql  7525 May 31  2015 save_binary_logs       # 保存和复制master的二进制日志</span><br></pre></td></tr></table></figure>

<h3 id="MHA自带配置文件"><a href="#MHA自带配置文件" class="headerlink" title="MHA自带配置文件"></a>MHA自带配置文件</h3><p> <code>MHA-manager</code> 编译完在 <code>samples</code> 目录下有配置文件模板和 <code>failover</code> 脚本供参考，这里用另外写的   </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; tree samples/</span><br><span class="line">samples/</span><br><span class="line">├── conf</span><br><span class="line">│   ├── app1.cnf</span><br><span class="line">│   └── masterha_default.cnf</span><br><span class="line">└── scripts</span><br><span class="line">    ├── master_ip_failover</span><br><span class="line">    ├── master_ip_online_change</span><br><span class="line">    ├── power_manager</span><br><span class="line">    └── send_report</span><br></pre></td></tr></table></figure>

<h2 id="MHA配置文件和脚本"><a href="#MHA配置文件和脚本" class="headerlink" title="MHA配置文件和脚本"></a>MHA配置文件和脚本</h2><blockquote>
<p>配置文件统一放在 &#x2F;etc&#x2F;masterha&#x2F; 中，针对当前这个 MySQL 复制组，我们定义为 app1.conf ，如果还有 其他 MySQL 复制组 ，可以 继续定义 app2.conf 、app3.conf等等  </p>
</blockquote>
<h3 id="示例配置文件细述"><a href="#示例配置文件细述" class="headerlink" title="示例配置文件细述"></a>示例配置文件细述</h3><p><code>/etc/masterha/app1.conf</code> 定义一个 mysql 集群如下内容</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># MHA Manager 端 /etc/masterha/app1.conf</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="section">[server default]</span></span><br><span class="line"><span class="comment"># 这两个参数需要根据不同的集群进行修改</span></span><br><span class="line"><span class="attr">manager_workdir</span>=/var/log/masterha/app1</span><br><span class="line"><span class="attr">manager_log</span>=/var/log/masterha/app1/manager.log</span><br><span class="line"><span class="comment"># 按照master服务器存放binlog的实际路径进行修改，主要为了让MHA拉取binlog</span></span><br><span class="line"><span class="attr">master_binlog_dir</span>=/data/mysql_data/<span class="number">5.7</span>.<span class="number">11</span>/</span><br><span class="line"><span class="comment"># 设置自动failover的脚本，下面会给出</span></span><br><span class="line"><span class="attr">master_ip_failover_script</span>= /usr/local/mha/bin/master_ip_failover</span><br><span class="line"><span class="comment"># 设置手动切换时候的脚本 （供(masterha_master_switch使用）</span></span><br><span class="line"><span class="attr">master_ip_online_change_script</span>= /usr/local/mha/bin/master_ip_online_change</span><br><span class="line"><span class="attr">log_level</span>=debug</span><br><span class="line"><span class="comment"># 监控的用户</span></span><br><span class="line"><span class="attr">user</span>=root</span><br><span class="line"><span class="comment"># 监控用户的密码</span></span><br><span class="line"><span class="attr">password</span>=<span class="number">111111</span></span><br><span class="line"><span class="comment"># 监控主库的时间间隔，默认是3秒，尝试三次没有回应的时候自动进行failover</span></span><br><span class="line"><span class="attr">ping_interval</span>=<span class="number">3</span></span><br><span class="line"><span class="comment"># 检测方式是insert， MHA-0.56开始支持insert</span></span><br><span class="line"><span class="comment"># 会在Master中生成一个 infra 数据库</span></span><br><span class="line"><span class="attr">ping_type</span>=INSERT</span><br><span class="line"><span class="comment"># 设置远端mysql在发生切换时binlog的保存位置</span></span><br><span class="line"><span class="attr">remote_workdir</span>=/tmp</span><br><span class="line"><span class="comment"># 复制用的密码</span></span><br><span class="line"><span class="attr">repl_password</span>=rpl</span><br><span class="line"><span class="comment"># 复制的用户</span></span><br><span class="line"><span class="attr">repl_user</span>=rpl</span><br><span class="line"><span class="comment"># 告警脚本，可自行修改，这里没有使用</span></span><br><span class="line"><span class="comment">#report_script=/usr/local/mha/bin/send_report</span></span><br><span class="line"><span class="comment"># 通过从机进行二次探测的脚本， IP地址按照实际的情况进行修改</span></span><br><span class="line"><span class="attr">secondary_check_script</span>=/usr/local/mha/bin/masterha_secondary_check -s <span class="number">192.168</span>.<span class="number">122.70</span> -s <span class="number">192.168</span>.<span class="number">122.80</span> --user=root --master_host=<span class="number">192.168</span>.<span class="number">122.66</span> --master_port=<span class="number">3307</span></span><br><span class="line"><span class="comment"># 设置故障发生后关闭故障主机的脚本（主要作用是关闭主机防止发生脑裂,这里没有使用，类似Fence功能）</span></span><br><span class="line"><span class="comment">#shutdown_script=&quot;/usr/local/mha/bin/power_manager --command=stopssh2 --host=test-1 --ssh_user=root&quot;</span></span><br><span class="line"><span class="comment"># 定义ssh的用户</span></span><br><span class="line"><span class="attr">ssh_user</span>=root</span><br><span class="line"><span class="section">[server1]</span></span><br><span class="line"><span class="comment"># 这个hostname也可以配置成IP地址，同 ip 参数一样</span></span><br><span class="line"><span class="comment"># 如果这里写名字，需要DNS配合，或者使用 /etc/hosts</span></span><br><span class="line"><span class="attr">hostname</span>=master</span><br><span class="line"><span class="attr">ip</span>=<span class="number">192.168</span>.<span class="number">122.66</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3307</span></span><br><span class="line"><span class="comment"># candidate_master参数的意思为：设置为候选Master，如果发生主从切换，该主机会被提升为Master，即使这个服务器上的数据不是最新的（会用relay-log补全）</span></span><br><span class="line"><span class="attr">candidate_master</span>=<span class="number">1</span></span><br><span class="line"><span class="section">[server2]</span></span><br><span class="line"><span class="attr">hostname</span>=slave1</span><br><span class="line"><span class="attr">ip</span>=<span class="number">192.168</span>.<span class="number">122.70</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3307</span></span><br><span class="line"><span class="attr">candidate_master</span>=<span class="number">1</span></span><br><span class="line"><span class="comment"># check_repl_delay参数的意思为：默认情况下如果一个slave落后master 100M的relay logs的话， MHA将不会选择该slave作为一个新的master；</span></span><br><span class="line"><span class="comment"># 因为对于这个slave的恢复需要花费很长时间;</span></span><br><span class="line"><span class="comment"># 通过设置check_repl_delay=0,MHA触发切换在选择一个新的master的时候将会忽略复制延时;</span></span><br><span class="line"><span class="comment"># 这个参数对于设置了candidate_master=1的主机非常有用，因为这个候选主在切换的过程中一定是新的master</span></span><br><span class="line"><span class="attr">check_repl_delay</span>=<span class="number">0</span></span><br><span class="line"><span class="section">[server3]</span></span><br><span class="line"><span class="attr">hostname</span>=slave2</span><br><span class="line"><span class="attr">ip</span>=<span class="number">192.168</span>.<span class="number">122.80</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3307</span></span><br><span class="line"><span class="comment"># no_master 表示该主机不会被提升为Master</span></span><br><span class="line"><span class="attr">no_master</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="failover脚本"><a href="#failover脚本" class="headerlink" title="failover脚本"></a>failover脚本</h3><p>failover 脚本，新建 <code>/usr/local/mha/bin/master_ip_failover</code> 文件，记得加执行权限</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env perl</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> strict;</span><br><span class="line"><span class="keyword">use</span> warnings <span class="string">FATAL =&gt;</span> <span class="string">&#x27;all&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> Getopt::Long;</span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> (</span><br><span class="line">    $command, $ssh_user, $orig_master_host, $orig_master_ip,</span><br><span class="line">    $orig_master_port, $new_master_host, $new_master_ip, $new_master_port</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意修改系统对应的接口名称（CentOS比较变态，若多节点可以升级成master，记得接口名称需要一样，比如都为eth0...）</span></span><br><span class="line"><span class="keyword">my</span> $vip = <span class="string">&#x27;192.168.122.99/24&#x27;</span>;</span><br><span class="line"><span class="keyword">my</span> $eth = <span class="string">&#x27;eth0&#x27;</span>;</span><br><span class="line"><span class="keyword">my</span> $key = <span class="string">&#x27;88&#x27;</span>;</span><br><span class="line"><span class="keyword">my</span> $ssh_start_vip = <span class="string">&quot;/sbin/ifconfig $eth:$key $vip&quot;</span>;</span><br><span class="line"><span class="keyword">my</span> $ssh_stop_vip = <span class="string">&quot;/sbin/ifconfig $eth:$key down&quot;</span>;</span><br><span class="line"></span><br><span class="line">GetOptions(</span><br><span class="line">    <span class="string">&#x27;command=s&#x27;</span> =&gt; \$command,</span><br><span class="line">    <span class="string">&#x27;ssh_user=s&#x27;</span> =&gt; \$ssh_user,</span><br><span class="line">    <span class="string">&#x27;orig_master_host=s&#x27;</span> =&gt; \$orig_master_host,</span><br><span class="line">    <span class="string">&#x27;orig_master_ip=s&#x27;</span> =&gt; \$orig_master_ip,</span><br><span class="line">    <span class="string">&#x27;orig_master_port=i&#x27;</span> =&gt; \$orig_master_port,</span><br><span class="line">    <span class="string">&#x27;new_master_host=s&#x27;</span> =&gt; \$new_master_host,</span><br><span class="line">    <span class="string">&#x27;new_master_ip=s&#x27;</span> =&gt; \$new_master_ip,</span><br><span class="line">    <span class="string">&#x27;new_master_port=i&#x27;</span> =&gt; \$new_master_port,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">exit</span> &amp;main();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">&quot;\n\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\n\n&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ( $command eq <span class="string">&quot;stop&quot;</span> || $command eq <span class="string">&quot;stopssh&quot;</span> ) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">my</span> $exit_code = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">eval</span> &#123;</span><br><span class="line">            <span class="keyword">print</span> <span class="string">&quot;Disabling the VIP on old master: $orig_master_host \n&quot;</span>;</span><br><span class="line">            &amp;stop_vip();</span><br><span class="line">            $exit_code = <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> ($@) &#123;</span><br><span class="line">            <span class="keyword">warn</span> <span class="string">&quot;Got Error: $@\n&quot;</span>;</span><br><span class="line">            <span class="keyword">exit</span> $exit_code;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">exit</span> $exit_code;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elsif</span> ( $command eq <span class="string">&quot;start&quot;</span> ) &#123;</span><br><span class="line">        <span class="keyword">my</span> $exit_code = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">eval</span> &#123;</span><br><span class="line">            <span class="keyword">print</span> <span class="string">&quot;Enabling the VIP - $vip on the new master - $new_master_host \n&quot;</span>;</span><br><span class="line">            &amp;start_vip();</span><br><span class="line">            $exit_code = <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> ($@) &#123;</span><br><span class="line">            <span class="keyword">warn</span> $@;</span><br><span class="line">            <span class="keyword">exit</span> $exit_code;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">exit</span> $exit_code;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elsif</span> ( $command eq <span class="string">&quot;status&quot;</span> ) &#123;</span><br><span class="line">        <span class="keyword">print</span> <span class="string">&quot;Checking the Status of the script.. OK \n&quot;</span>;</span><br><span class="line">        <span class="keyword">exit</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        &amp;usage();</span><br><span class="line">        <span class="keyword">exit</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">start_vip</span>() </span>&#123;</span><br><span class="line">    <span class="string">`ssh $ssh_user\@$new_master_host \&quot; $ssh_start_vip \&quot;`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">stop_vip</span>() </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span> <span class="keyword">unless</span> ($ssh_user);</span><br><span class="line">    <span class="string">`ssh $ssh_user\@$orig_master_host \&quot; $ssh_stop_vip \&quot;`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">usage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">print</span></span><br><span class="line">    <span class="string">&quot;Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="在线切换master的脚本"><a href="#在线切换master的脚本" class="headerlink" title="在线切换master的脚本"></a>在线切换master的脚本</h3><p>创建在线切换 master 的脚本 <code>/usr/local/mha/bin/master_ip_online_change</code>，同样加执行权限  </p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env perl</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> strict;</span><br><span class="line"><span class="keyword">use</span> warnings <span class="string">FATAL =&gt;</span> <span class="string">&#x27;all&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> Getopt::Long;</span><br><span class="line"></span><br><span class="line"><span class="comment">#my (</span></span><br><span class="line"><span class="comment"># $command, $ssh_user, $orig_master_host, $orig_master_ip,</span></span><br><span class="line"><span class="comment"># $orig_master_port, $new_master_host, $new_master_ip, $new_master_port</span></span><br><span class="line"><span class="comment">#);</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> (</span><br><span class="line">    $command,              $orig_master_is_new_slave, $orig_master_host,</span><br><span class="line">    $orig_master_ip,       $orig_master_port,         $orig_master_user,</span><br><span class="line">    $orig_master_password, $orig_master_ssh_user,     $new_master_host,</span><br><span class="line">    $new_master_ip,        $new_master_port,          $new_master_user,</span><br><span class="line">    $new_master_password,  $new_master_ssh_user,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 同样注意修改系统对应的接口名称，和对应的VIP</span></span><br><span class="line"><span class="keyword">my</span> $vip = <span class="string">&#x27;192.168.122.99/24&#x27;</span>;</span><br><span class="line"><span class="keyword">my</span> $eth = <span class="string">&#x27;eth0&#x27;</span>;</span><br><span class="line"><span class="keyword">my</span> $key = <span class="string">&#x27;88&#x27;</span>;</span><br><span class="line"><span class="keyword">my</span> $ssh_start_vip = <span class="string">&quot;/sbin/ifconfig $eth:$key $vip&quot;</span>;</span><br><span class="line"><span class="keyword">my</span> $ssh_stop_vip = <span class="string">&quot;/sbin/ifconfig $eth:$key down&quot;</span>;</span><br><span class="line"><span class="keyword">my</span> $ssh_user = <span class="string">&quot;root&quot;</span>;</span><br><span class="line"></span><br><span class="line">GetOptions(</span><br><span class="line">    <span class="string">&#x27;command=s&#x27;</span> =&gt; \$command,</span><br><span class="line">    <span class="comment">#&#x27;ssh_user=s&#x27; =&gt; \$ssh_user,</span></span><br><span class="line">    <span class="comment">#&#x27;orig_master_host=s&#x27; =&gt; \$orig_master_host,</span></span><br><span class="line">    <span class="comment">#&#x27;orig_master_ip=s&#x27; =&gt; \$orig_master_ip,</span></span><br><span class="line">    <span class="comment">#&#x27;orig_master_port=i&#x27; =&gt; \$orig_master_port,</span></span><br><span class="line">    <span class="comment">#&#x27;new_master_host=s&#x27; =&gt; \$new_master_host,</span></span><br><span class="line">    <span class="comment">#&#x27;new_master_ip=s&#x27; =&gt; \$new_master_ip,</span></span><br><span class="line">    <span class="comment">#&#x27;new_master_port=i&#x27; =&gt; \$new_master_port,</span></span><br><span class="line">    <span class="string">&#x27;orig_master_is_new_slave&#x27;</span> =&gt; \$orig_master_is_new_slave,</span><br><span class="line">    <span class="string">&#x27;orig_master_host=s&#x27;</span> =&gt; \$orig_master_host,</span><br><span class="line">    <span class="string">&#x27;orig_master_ip=s&#x27;</span> =&gt; \$orig_master_ip,</span><br><span class="line">    <span class="string">&#x27;orig_master_port=i&#x27;</span> =&gt; \$orig_master_port,</span><br><span class="line">    <span class="string">&#x27;orig_master_user=s&#x27;</span> =&gt; \$orig_master_user,</span><br><span class="line">    <span class="string">&#x27;orig_master_password=s&#x27;</span> =&gt; \$orig_master_password,</span><br><span class="line">    <span class="string">&#x27;orig_master_ssh_user=s&#x27;</span> =&gt; \$orig_master_ssh_user,</span><br><span class="line">    <span class="string">&#x27;new_master_host=s&#x27;</span> =&gt; \$new_master_host,</span><br><span class="line">    <span class="string">&#x27;new_master_ip=s&#x27;</span> =&gt; \$new_master_ip,</span><br><span class="line">    <span class="string">&#x27;new_master_port=i&#x27;</span> =&gt; \$new_master_port,</span><br><span class="line">    <span class="string">&#x27;new_master_user=s&#x27;</span> =&gt; \$new_master_user,</span><br><span class="line">    <span class="string">&#x27;new_master_password=s&#x27;</span> =&gt; \$new_master_password,</span><br><span class="line">    <span class="string">&#x27;new_master_ssh_user=s&#x27;</span> =&gt; \$new_master_ssh_user,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">exit</span> &amp;main();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">&quot;\n\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\n\n&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ( $command eq <span class="string">&quot;stop&quot;</span> || $command eq <span class="string">&quot;stopssh&quot;</span> ) &#123;</span><br><span class="line">        <span class="keyword">my</span> $exit_code = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">eval</span> &#123;</span><br><span class="line">            <span class="keyword">print</span> <span class="string">&quot;Disabling the VIP on old master: $orig_master_host \n&quot;</span>;</span><br><span class="line">            &amp;stop_vip();</span><br><span class="line">            $exit_code = <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> ($@) &#123;</span><br><span class="line">            <span class="keyword">warn</span> <span class="string">&quot;Got Error: $@\n&quot;</span>;</span><br><span class="line">            <span class="keyword">exit</span> $exit_code;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">exit</span> $exit_code;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elsif</span> ( $command eq <span class="string">&quot;start&quot;</span> ) &#123;</span><br><span class="line">        <span class="keyword">my</span> $exit_code = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">eval</span> &#123;</span><br><span class="line">            <span class="keyword">print</span> <span class="string">&quot;Enabling the VIP - $vip on the new master - $new_master_host \n&quot;</span>;</span><br><span class="line">            &amp;start_vip();</span><br><span class="line">            $exit_code = <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> ($@) &#123;</span><br><span class="line">            <span class="keyword">warn</span> $@;</span><br><span class="line">            <span class="keyword">exit</span> $exit_code;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">exit</span> $exit_code;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elsif</span> ( $command eq <span class="string">&quot;status&quot;</span> ) &#123;</span><br><span class="line">        <span class="keyword">print</span> <span class="string">&quot;Checking the Status of the script.. OK \n&quot;</span>;</span><br><span class="line">        <span class="keyword">exit</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        &amp;usage();</span><br><span class="line">        <span class="keyword">exit</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">start_vip</span>() </span>&#123;</span><br><span class="line">    <span class="string">`ssh $ssh_user\@$new_master_host \&quot; $ssh_start_vip \&quot;`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">stop_vip</span>() </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span> <span class="keyword">unless</span> ($ssh_user);</span><br><span class="line">    <span class="string">`ssh $ssh_user\@$orig_master_host \&quot; $ssh_stop_vip \&quot;`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">usage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">print</span></span><br><span class="line">    <span class="string">&quot;Usage: master_ip_failover --command=start|stop|stopssh|status --ssh-user=user --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Slave上的relay-log配置"><a href="#Slave上的relay-log配置" class="headerlink" title="Slave上的relay_log配置"></a>Slave上的relay_log配置</h3><p>&emsp;&emsp;从 MHA Failover 的过程中可以了解到， MHA Manager 在恢复（ 补齐）其他 Slave 数据时会用到 relay-log ，因此这些 relay-log 需要被保留。</p>
<p>&emsp;&emsp;而默认情况下， SQL 线程在回放完毕后， MySQL 会 主动删除 relay-log ，需要 禁用 该功能，确保 relay-log 不被自动删除。</p>
<p>所以在所有 Slave 节点 中配置如下参数，然后重启mysql服务。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有的Slave节点</span></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># 关闭relay-log主动删除的功能</span></span><br><span class="line"><span class="attr">relay_log_purge</span> = <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>但是这样做了以后又带来另外一个问题，<code>relay-log</code> 会大量堆积导致磁盘空间紧张，所以需要定时清空过时的<code>relay-log</code>。<code>MHA Node</code> 的安装包中有一个 <code>pure_relay_logs</code> 工具，提供删除大量 relay-log 的功能。</p>
<h3 id="pure-relay-logs工具"><a href="#pure-relay-logs工具" class="headerlink" title="pure_relay_logs工具"></a>pure_relay_logs工具</h3><blockquote>
<p><strong>该工具原理</strong>：在Linux下删除体积较大的文件需要一定的时间，且消耗一定的资源，所以 <code>pure_relay_logs</code> 在删除relay-log 之前会做一次 硬连接 ，然后删除对应的 relay-log （只删除指向 <code>relay-log</code> 的 指针 ），这样不会造成系统资源消耗，从而影响复制（ 造成复制延时），最后再 删除硬连接的<code>relay-log</code>（_hardlink_） 。    </p>
</blockquote>
<p>参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">--user ： 用户名</span><br><span class="line">--password ： 密码</span><br><span class="line">--port ： 端口号</span><br><span class="line">--workdir ： 指定 创建relay-log的硬链接 的位置</span><br><span class="line">    默认是 /var/tmp ，由于 硬连接不能跨分区 ，所以请 确保这个目录和你的relay-log在同一个分区 ；</span><br><span class="line">    当脚本执行成功后，硬链接会被删除</span><br><span class="line">--disable_relay_log_purge ： 默认情况下，如果 relay_log_purge=1 ，脚本会什么都不清理，自动退出</span><br><span class="line">    通过设定这个参数，当 relay_log_purge=1 的情况下，该参数会将relay_log_purge设置为0。清理relay log之后，最后再设置 relay_log_purge=0 。</span><br><span class="line">    但是还是要在 /etc/my.cnf 中显示配置 relay_log_purge=0 ，避免重启服务后被还原。</span><br></pre></td></tr></table></figure>

<p>可以增加如下定时清理脚本到定时任务中，大概几个小时执行一次</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">user=root</span><br><span class="line">passwd=123</span><br><span class="line">port=3306</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">目录可以创建</span></span><br><span class="line">log_dir=&#x27;/mysql/purge_relay_logs&#x27;</span><br><span class="line">work_dir=&#x27;/mysql/relay_log_hardlink&#x27;</span><br><span class="line">purge=&#x27;/usr/local/mha/bin/purge_relay_logs&#x27;</span><br><span class="line"></span><br><span class="line">if [[ ! -d $&#123;work_dir&#125; ]];then</span><br><span class="line">	mkdir $&#123;work_dir&#125; -p</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [[ ! -d $&#123;log_dir&#125; ]];then</span><br><span class="line">	mkdir $&#123;log_dir&#125; -p</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">&#123;purge&#125; --user=<span class="variable">$&#123;user&#125;</span> --password=<span class="variable">$&#123;passwd&#125;</span> --port=<span class="variable">$&#123;port&#125;</span> --workdir=<span class="variable">$&#123;work_dir&#125;</span> \</span></span><br><span class="line"><span class="language-bash">         --disable_relay_log_purge &gt;&gt; <span class="variable">$&#123;log_dir&#125;</span>/purge_relay_logs.log 2&gt;&amp;1</span></span><br></pre></td></tr></table></figure>

<h3 id="Manager检测配置中主机状态"><a href="#Manager检测配置中主机状态" class="headerlink" title="Manager检测配置中主机状态"></a>Manager检测配置中主机状态</h3><p>到次配置几乎完成，但是还未启动，可以在 MAH manager 机器运行 ssh 检测和复制关系检测</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ssh检测</span></span><br><span class="line"><span class="meta prompt_">shell&gt; </span><span class="language-bash">masterha_check_ssh --conf=/etc/masterha/app1.conf   <span class="comment"># 下面是检测正常</span></span></span><br><span class="line">Wed Mar 14 09:55:45 2018 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Wed Mar 14 09:55:45 2018 - [info] Reading application default configuration from /etc/masterha/app1.conf..</span><br><span class="line">Wed Mar 14 09:55:45 2018 - [info] Reading server configuration from /etc/masterha/app1.conf..</span><br><span class="line">Wed Mar 14 09:55:45 2018 - [info] Starting SSH connection tests..</span><br><span class="line">Wed Mar 14 09:55:46 2018 - [debug] </span><br><span class="line">Wed Mar 14 09:55:45 2018 - [debug]  Connecting via SSH from root@master(192.168.122.66:22) to root@slave1(192.168.122.70:22)..</span><br><span class="line">Wed Mar 14 09:55:45 2018 - [debug]   ok.</span><br><span class="line">Wed Mar 14 09:55:45 2018 - [debug]  Connecting via SSH from root@master(192.168.122.66:22) to root@slave2(192.168.122.80:22)..</span><br><span class="line">Wed Mar 14 09:55:46 2018 - [debug]   ok.</span><br><span class="line">Wed Mar 14 09:55:47 2018 - [debug] </span><br><span class="line">Wed Mar 14 09:55:46 2018 - [debug]  Connecting via SSH from root@slave2(192.168.122.80:22) to root@master(192.168.122.66:22)..</span><br><span class="line">Wed Mar 14 09:55:47 2018 - [debug]   ok.</span><br><span class="line">Wed Mar 14 09:55:47 2018 - [debug]  Connecting via SSH from root@slave2(192.168.122.80:22) to root@slave1(192.168.122.70:22)..</span><br><span class="line">Wed Mar 14 09:55:47 2018 - [debug]   ok.</span><br><span class="line">Wed Mar 14 09:55:47 2018 - [debug] </span><br><span class="line">Wed Mar 14 09:55:45 2018 - [debug]  Connecting via SSH from root@slave1(192.168.122.70:22) to root@master(192.168.122.66:22)..</span><br><span class="line">Wed Mar 14 09:55:46 2018 - [debug]   ok.</span><br><span class="line">Wed Mar 14 09:55:46 2018 - [debug]  Connecting via SSH from root@slave1(192.168.122.70:22) to root@slave2(192.168.122.80:22)..</span><br><span class="line">Wed Mar 14 09:55:47 2018 - [debug]   ok.</span><br><span class="line">Wed Mar 14 09:55:47 2018 - [info] All SSH connection tests passed successfully.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制关系检测</span></span><br><span class="line"><span class="meta prompt_">shell&gt; </span><span class="language-bash">masterha_check_repl --conf=/etc/masterha/app1.conf</span></span><br><span class="line">Wed Mar 14 09:57:00 2018 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Wed Mar 14 09:57:00 2018 - [info] Reading application default configuration from /etc/masterha/app1.conf..</span><br><span class="line">Wed Mar 14 09:57:00 2018 - [info] Reading server configuration from /etc/masterha/app1.conf..</span><br><span class="line">Wed Mar 14 09:57:00 2018 - [info] MHA::MasterMonitor version 0.57.</span><br><span class="line">Wed Mar 14 09:57:00 2018 - [debug] Connecting to servers..</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [debug]  Connected to: master(192.168.122.66:3307), user=root</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [debug]  Number of slave worker threads on host master(192.168.122.66:3307): 0</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [debug]  Connected to: slave1(192.168.122.70:3307), user=root</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [debug]  Number of slave worker threads on host slave1(192.168.122.70:3307): 8</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [debug]  Connected to: slave2(192.168.122.80:3307), user=root</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [debug]  Number of slave worker threads on host slave2(192.168.122.80:3307): 16</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [debug]  Comparing MySQL versions..</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [debug]   Comparing MySQL versions done.</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [debug] Connecting to servers done.</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info] GTID failover mode = 1</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info] Dead Servers:</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info] Alive Servers:</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info]   master(192.168.122.66:3307)</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info]   slave1(192.168.122.70:3307)</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info]   slave2(192.168.122.80:3307)</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info] Alive Slaves:</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info]   slave1(192.168.122.70:3307)  Version=5.7.21-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info]     GTID ON</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [debug]    Relay log info repository: TABLE</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info]     Replicating from 192.168.122.66(192.168.122.66:3307)</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info]   slave2(192.168.122.80:3307)  Version=5.7.21-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info]     GTID ON</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [debug]    Relay log info repository: TABLE</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info]     Replicating from 192.168.122.66(192.168.122.66:3307)</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info]     Not candidate for the new Master (no_master is set)</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info] Current Alive Master: master(192.168.122.66:3307)</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info] Checking slave configurations..</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info]  read_only=1 is not set on slave slave1(192.168.122.70:3307).</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info]  read_only=1 is not set on slave slave2(192.168.122.80:3307).</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info] Checking replication filtering settings..</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info]  Replication filtering check ok.</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [debug] SSH connection test to master, option -o StrictHostKeyChecking=no -o PasswordAuthentication=no -o BatchMode=yes -o ConnectTimeout=5, timeout 5</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info] HealthCheck: SSH to master is reachable.</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info] </span><br><span class="line">master(192.168.122.66:3307) (current master)  # -- 有输出拓扑图和slave健康状况的信息</span><br><span class="line"> +--slave1(192.168.122.70:3307)</span><br><span class="line"> +--slave2(192.168.122.80:3307)</span><br><span class="line"></span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info] Checking replication health on slave1..</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info]  ok.</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info] Checking replication health on slave2..</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info]  ok.</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info]   /usr/local/mha/bin/master_ip_failover --command=status --ssh_user=root --orig_master_host=master --orig_master_ip=192.168.122.66 --orig_master_port=3307 </span><br><span class="line"></span><br><span class="line">IN SCRIPT TEST====/sbin/ifconfig eth0:88 down==/sbin/ifconfig eth0:88 192.168.122.99/24===</span><br><span class="line"></span><br><span class="line">Checking the Status of the script.. OK </span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info]  OK.</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [warning] shutdown_script is not defined.</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [debug]  Disconnected from master(192.168.122.66:3307)</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [debug]  Disconnected from slave1(192.168.122.70:3307)</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [debug]  Disconnected from slave2(192.168.122.80:3307)</span><br><span class="line">Wed Mar 14 09:57:01 2018 - [info] Got exit code 0 (Not master dead).</span><br><span class="line"></span><br><span class="line">MySQL Replication Health is OK.</span><br></pre></td></tr></table></figure>

<h2 id="启动MHA"><a href="#启动MHA" class="headerlink" title="启动MHA"></a>启动MHA</h2><h3 id="为master添加浮动ip"><a href="#为master添加浮动ip" class="headerlink" title="为master添加浮动ip"></a>为master添加浮动ip</h3><p>&emsp;&emsp;添加 VIP，因为这里使用的是 <code>masterha_ip_failover</code> 脚本切换 VIP，由于这个脚本的 <code>start/stop</code> 操作只有在 <code>Failover</code> (切换)期间才会执行，所以即便设置了该脚本的 vip，<strong>MHA 也不会在<code>masterha_manager</code>一开始启动的时候，在 Master 上设置 VIP</strong>，<strong>初次在 Master 上设置 VIP 需要人工操作</strong>，后期如果有 <code>Failover</code> 操作， MHA 会执行脚本，自动切换到新选取的主机器上。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Master 端</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在我的测试机中，网卡名称为eth0，两台可以提升成主的设备都是eth0网卡</span></span><br><span class="line"><span class="meta prompt_">shell&gt; </span><span class="language-bash">ifconfig eth0:88 192.168.122.99/24</span></span><br></pre></td></tr></table></figure>

<h3 id="启动masterha-manager"><a href="#启动masterha-manager" class="headerlink" title="启动masterha_manager"></a>启动<code>masterha_manager</code></h3><p>一些参数</p>
<ul>
<li><code>--conf</code> ：当前 MySQL 集群的配置文件，可以有多个，应用于不同的集群</li>
<li><code>--remove_dead_master_conf</code> ：当发生切换操作 Failover 后，需要把之前的 Dead Master 从配置文件中删除。<ul>
<li>如果不删除，且没有恢复的话，此时  masterha_manager 重启后，会报错 “there is a dead slave”</li>
</ul>
</li>
<li><code>--ignore_last_failover</code> ：如果前一次 Failover 失败了， MHA 不会去再一次去做 <code>Failover</code> 操作，除非人为的删除 <code>(manager_workdir)/(app_name).failover.error</code> ，或者增加此参数， MHA 会继续进行 Failover 操作。</li>
</ul>
<p>启动 MHA 的管理服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 启动MHA manager</span><br><span class="line">shell&gt; nohup masterha_manager --conf=/etc/masterha/app1.conf --remove_dead_master_conf --ignore_last_failover &lt; /dev/null &gt; /var/log/masterha/app1/manager.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line">shell&gt; masterha_check_status --conf=/etc/masterha/app1.conf</span><br><span class="line">app1 (pid:18702) is running(0:PING_OK), master:Master</span><br><span class="line"># 状态正常，且当前主机是 Master</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;日志可以查看 <code>/var/log/masterha/app1/manager.log</code>，在 failover 成功后会把旧 master 的配置段删掉，如切换 VIP 后我们配置文件中的 server1(192.168.122.66:3307) 配置段将被删。</p>
<h2 id="测试MHA自动Failover"><a href="#测试MHA自动Failover" class="headerlink" title="测试MHA自动Failover"></a>测试MHA自动Failover</h2><blockquote>
<p>在做 Failover 测试之前，把 MHA Manager 停掉，把 MySQL 节点也都停掉（ 注意停止顺序 ），把数据库进行一次冷备份，方便以后测试。若没测试成功可以移回冷备文件继续测。</p>
</blockquote>
<ol>
<li>停掉 Slave的 IO 线程 ，模拟复制延时（ Slave1保持不变）</li>
<li>使用 sysbench 对 Master 进行测试，生成测试数据（可以产生大量的 binlog）</li>
<li>等待步骤2完成 后，开启 Slave 上的 IO 线程，让它去追 Master 的 binlog，同时立即操作第四步</li>
<li>关闭  Master 上的 MySQL，让 MHA 产生 Failover 操作</li>
<li>观察最终状态</li>
</ol>
<p>附发生<code>failover</code>时的<code>MHA Manager</code>日志</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br></pre></td><td class="code"><pre><span class="line">Tue Mar 13 17:10:50 2018 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Tue Mar 13 17:10:50 2018 - [info] Reading application default configuration from /etc/masterha/app1.conf..</span><br><span class="line">Tue Mar 13 17:10:50 2018 - [info] Reading server configuration from /etc/masterha/app1.conf..</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info] Reading application default configuration from /etc/masterha/app1.conf..</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info] Reading server configuration from /etc/masterha/app1.conf..</span><br><span class="line">tory. Check for details, and consider setting --workdir separately.</span><br><span class="line">Tue Mar 13 17:10:50 2018 - [debug] Connecting to servers..</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [debug]  Connected to: master(192.168.122.66:3307), user=root</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [debug]  Number of slave worker threads on host master(192.168.122.66:3307): 0</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [debug]  Connected to: slave1(192.168.122.70:3307), user=root</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [debug]  Number of slave worker threads on host slave1(192.168.122.70:3307): 8</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [debug]  Connected to: slave2(192.168.122.80:3307), user=root</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [debug]  Number of slave worker threads on host slave2(192.168.122.80:3307): 16</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [debug]  Comparing MySQL versions..</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [debug]   Comparing MySQL versions done.</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [debug] Connecting to servers done.</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [info] GTID failover mode = 1</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [info] Dead Servers:</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [info] Alive Servers:</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [info]   master(192.168.122.66:3307)</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [info]   slave1(192.168.122.70:3307)</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [info]   slave2(192.168.122.80:3307)</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [info] Alive Slaves:</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [info]   slave1(192.168.122.70:3307)  Version=5.7.21-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [info]     GTID ON</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [debug]    Relay log info repository: TABLE</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [info]     Replicating from 192.168.122.66(192.168.122.66:3307)</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [info]   slave2(192.168.122.80:3307)  Version=5.7.21-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [info]     GTID ON</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [debug]    Relay log info repository: TABLE</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [info]     Replicating from 192.168.122.66(192.168.122.66:3307)</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [info]     Not candidate for the new Master (no_master is set)</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [info] Current Alive Master: master(192.168.122.66:3307)</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [info] Checking slave configurations..</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [info]  read_only=1 is not set on slave slave1(192.168.122.70:3307).</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [info]  read_only=1 is not set on slave slave2(192.168.122.80:3307).</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [info] Checking replication filtering settings..</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Tue Mar 13 17:10:51 2018 - [info]  Replication filtering check ok.</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Tue Mar 13 17:10:51 2018 - [debug] SSH connection test to master, option -o StrictHostKeyChecking=no -o PasswordAuthentication=no -o BatchMode=yes -o ConnectTimeout=5, timeout 5</span><br><span class="line">Tue Mar 13 17:10:52 2018 - [info] HealthCheck: SSH to master is reachable.</span><br><span class="line">Tue Mar 13 17:10:52 2018 - [info] </span><br><span class="line">master(192.168.122.66:3307) (current master)</span><br><span class="line"> +--slave1(192.168.122.70:3307)</span><br><span class="line"> +--slave2(192.168.122.80:3307)</span><br><span class="line"></span><br><span class="line">Tue Mar 13 17:10:52 2018 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Tue Mar 13 17:10:52 2018 - [info]   /usr/local/mha/bin/master_ip_failover --command=status --ssh_user=root --orig_master_host=master --orig_master_ip=192.168.122.66 --orig_master_port=3307 </span><br><span class="line"></span><br><span class="line">IN SCRIPT TEST====/sbin/ifconfig eth0:88 down==/sbin/ifconfig eth0:88 192.168.122.99/24===</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">还没故障转移的正常启动日志</span></span><br><span class="line">Checking the Status of the script.. OK </span><br><span class="line">Tue Mar 13 17:10:52 2018 - [info]  OK.</span><br><span class="line">Tue Mar 13 17:10:52 2018 - [warning] shutdown_script is not defined.</span><br><span class="line">Tue Mar 13 17:10:52 2018 - [debug]  Disconnected from master(192.168.122.66:3307)</span><br><span class="line">Tue Mar 13 17:10:52 2018 - [debug]  Disconnected from slave1(192.168.122.70:3307)</span><br><span class="line">Tue Mar 13 17:10:52 2018 - [debug]  Disconnected from slave2(192.168.122.80:3307)</span><br><span class="line">Tue Mar 13 17:10:52 2018 - [debug] SSH check command: exit 0</span><br><span class="line">Tue Mar 13 17:10:52 2018 - [info] Set master ping interval 3 seconds.</span><br><span class="line">Tue Mar 13 17:10:52 2018 - [info] Set secondary check script: /usr/local/mha/bin/masterha_secondary_check -s 192.168.122.70 -s 192.168.122.80 --user=root --master_host=192.168.122.66 --master_port=3307</span><br><span class="line">Tue Mar 13 17:10:52 2018 - [info] Starting ping health check on master(192.168.122.66:3307)..</span><br><span class="line">Tue Mar 13 17:10:52 2018 - [debug] Connected on master.</span><br><span class="line">Tue Mar 13 17:10:52 2018 - [debug] Set short wait_timeout on master: 6 seconds</span><br><span class="line">Tue Mar 13 17:10:52 2018 - [debug] Trying to get advisory lock..</span><br><span class="line">Tue Mar 13 17:10:52 2018 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;t respond..  # 开始等待mysql不响应</span><br><span class="line">Tue Mar 13 17:12:13 2018 - [warning] Got error on MySQL insert ping: 2006 (MySQL server has gone away)    # 此时发现master实例ping不通了</span><br><span class="line">Tue Mar 13 17:12:13 2018 - [info] Executing secondary network check script: /usr/local/mha/bin/masterha_secondary_check -s 192.168.122.70 -s 192.168.122.80 --user=root --master_host=192.168.122.66 --master_port=3307  --user=root  --master_host=master  --master_ip=192.168.122.66  --master_port=3307 --master_user=root --master_password=111111 --ping_type=INSERT</span><br><span class="line">Tue Mar 13 17:12:13 2018 - [info] Executing SSH check script: exit 0</span><br><span class="line">Tue Mar 13 17:12:13 2018 - [debug] SSH connection test to master, option -o StrictHostKeyChecking=no -o PasswordAuthentication=no -o BatchMode=yes -o ConnectTimeout=5, timeout 5</span><br><span class="line">Tue Mar 13 17:12:13 2018 - [info] HealthCheck: SSH to master is reachable.    # 用两个slave实例检测ssh是否能到master</span><br><span class="line">Monitoring server 192.168.122.70 is reachable, Master is not reachable from 192.168.122.70. OK.</span><br><span class="line">Monitoring server 192.168.122.80 is reachable, Master is not reachable from 192.168.122.80. OK.</span><br><span class="line">Tue Mar 13 17:12:14 2018 - [info] Master is not reachable from all other monitoring servers. Failover should start.  # 两个slave都不能连到master的mysql实例，重试3次</span><br><span class="line">Tue Mar 13 17:12:16 2018 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;192.168.122.66&#x27; (111))</span><br><span class="line">Tue Mar 13 17:12:16 2018 - [warning] Connection failed 2 time(s)..</span><br><span class="line">Tue Mar 13 17:12:19 2018 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;192.168.122.66&#x27; (111))</span><br><span class="line">Tue Mar 13 17:12:19 2018 - [warning] Connection failed 3 time(s)..</span><br><span class="line">Tue Mar 13 17:12:22 2018 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;192.168.122.66&#x27; (111))</span><br><span class="line">Tue Mar 13 17:12:22 2018 - [warning] Connection failed 4 time(s)..</span><br><span class="line">Tue Mar 13 17:12:22 2018 - [warning] Master is not reachable from health checker!</span><br><span class="line">Tue Mar 13 17:12:22 2018 - [warning] Master master(192.168.122.66:3307) is not reachable!</span><br><span class="line">Tue Mar 13 17:12:22 2018 - [warning] SSH is reachable.</span><br><span class="line">Tue Mar 13 17:12:22 2018 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha_default.cnf and /etc/masterha/app1.conf again, and trying to connect to all servers to check server status..</span><br><span class="line">Tue Mar 13 17:12:22 2018 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Tue Mar 13 17:12:22 2018 - [info] Reading application default configuration from /etc/masterha/app1.conf..</span><br><span class="line">Tue Mar 13 17:12:22 2018 - [info] Reading server configuration from /etc/masterha/app1.conf..</span><br><span class="line">Tue Mar 13 17:12:22 2018 - [debug] Skipping connecting to dead master master(192.168.122.66:3307).</span><br><span class="line">Tue Mar 13 17:12:22 2018 - [debug] Connecting to servers..</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [debug]  Connected to: slave1(192.168.122.70:3307), user=root</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [debug]  Number of slave worker threads on host slave1(192.168.122.70:3307): 8</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [debug]  Connected to: slave2(192.168.122.80:3307), user=root</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [debug]  Number of slave worker threads on host slave2(192.168.122.80:3307): 16</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [debug]  Comparing MySQL versions..</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [debug]   Comparing MySQL versions done.</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [debug] Connecting to servers done.</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info] GTID failover mode = 1</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info] Dead Servers:    # master 已经dead</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info]   master(192.168.122.66:3307)</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info] Alive Servers:</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info]   slave1(192.168.122.70:3307)</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info]   slave2(192.168.122.80:3307)</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info] Alive Slaves:</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info]   slave1(192.168.122.70:3307)  Version=5.7.21-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info]     GTID ON</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [debug]    Relay log info repository: TABLE</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info]     Replicating from 192.168.122.66(192.168.122.66:3307)</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info]     Primary candidate for the new Master (candidate_master is set)    </span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info]   slave2(192.168.122.80:3307)  Version=5.7.21-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info]     GTID ON</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [debug]    Relay log info repository: TABLE</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info]     Replicating from 192.168.122.66(192.168.122.66:3307)</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info]     Not candidate for the new Master (no_master is set)    </span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info] Checking slave configurations..</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info]  read_only=1 is not set on slave slave1(192.168.122.70:3307).</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info]  read_only=1 is not set on slave slave2(192.168.122.80:3307).</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info] Checking replication filtering settings..</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info]  Replication filtering check ok.</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info] Master is down!</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info] Terminating monitoring script.</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [debug]  Disconnected from slave1(192.168.122.70:3307)</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [debug]  Disconnected from slave2(192.168.122.80:3307)</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info] Got exit code 20 (Master dead).</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info] MHA::MasterFailover version 0.57.</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info] Starting master failover.</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info] </span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info] * Phase 1: Configuration Check Phase..</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [info] </span><br><span class="line">Tue Mar 13 17:12:23 2018 - [debug] Skipping connecting to dead master master.</span><br><span class="line">Tue Mar 13 17:12:23 2018 - [debug] Connecting to servers..</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [debug]  Connected to: slave1(192.168.122.70:3307), user=root</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [debug]  Number of slave worker threads on host slave1(192.168.122.70:3307): 8</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [debug]  Connected to: slave2(192.168.122.80:3307), user=root</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [debug]  Number of slave worker threads on host slave2(192.168.122.80:3307): 16</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [debug]  Comparing MySQL versions..</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [debug]   Comparing MySQL versions done.</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [debug] Connecting to servers done.</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] GTID failover mode = 1</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] Dead Servers:</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]   master(192.168.122.66:3307)</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] Alive Servers:</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]   slave1(192.168.122.70:3307)</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]   slave2(192.168.122.80:3307)</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] Alive Slaves:</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]   slave1(192.168.122.70:3307)  Version=5.7.21-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]     GTID ON</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [debug]    Relay log info repository: TABLE</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]     Replicating from 192.168.122.66(192.168.122.66:3307)</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]     Primary candidate for the new Master (candidate_master is set)     # 存活的slave中slave1是配置了可以提升为master的</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]   slave2(192.168.122.80:3307)  Version=5.7.21-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]     GTID ON</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [debug]    Relay log info repository: TABLE</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]     Replicating from 192.168.122.66(192.168.122.66:3307)</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]     Not candidate for the new Master (no_master is set)    # slave2配置文件未设置能提升为master</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] Starting GTID based failover.</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] </span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] ** Phase 1: Configuration Check Phase completed.</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] </span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] * Phase 2: Dead Master Shutdown Phase..</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] </span><br><span class="line">Tue Mar 13 17:12:24 2018 - [debug]  Stopping IO thread on slave1(192.168.122.70:3307)..      # 停止slave1的IO线程</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] Forcing shutdown so that applications never connect to the current master..</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] Executing master IP deactivation script:</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]   /usr/local/mha/bin/master_ip_failover --orig_master_host=master --orig_master_ip=192.168.122.66 --orig_master_port=3307 --command=stopssh --ssh_user=root  </span><br><span class="line">Tue Mar 13 17:12:24 2018 - [debug]  Stopping IO thread on slave2(192.168.122.80:3307)..</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [debug]  Stop IO thread on slave2(192.168.122.80:3307) done.</span><br><span class="line"></span><br><span class="line">INSCRIPT TEST====/sbin/ifconfig eth0:88 down==/sbin/ifconfig eth0:88 192.168.122.99/24===</span><br><span class="line"></span><br><span class="line">Disabling the VIP on old master: master </span><br><span class="line">Tue Mar 13 17:12:24 2018 - [debug]  Stop IO thread on slave1(192.168.122.70:3307) done.</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]  done.</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] * Phase 2: Dead Master Shutdown Phase completed.</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] </span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] * Phase 3: Master Recovery Phase..</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] </span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] * Phase 3.1: Getting Latest Slaves Phase..</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] </span><br><span class="line">Tue Mar 13 17:12:24 2018 - [debug] Fetching current slave status..</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [debug]  Fetching current slave status done.</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] The latest binary log file/position on all slaves is bin.000004:20816</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] Retrieved Gtid Set: 0c154ad5-2699-11e8-94a1-525400eac085:309-394</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] Latest slaves (Slaves that received relay log files to the latest):</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]   slave1(192.168.122.70:3307)  Version=5.7.21-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]     GTID ON</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [debug]    Relay log info repository: TABLE</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]     Replicating from 192.168.122.66(192.168.122.66:3307)</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]   slave2(192.168.122.80:3307)  Version=5.7.21-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]     GTID ON</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [debug]    Relay log info repository: TABLE</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]     Replicating from 192.168.122.66(192.168.122.66:3307)</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]     Not candidate for the new Master (no_master is set)</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] The oldest binary log file/position on all slaves is bin.000004:20816</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] Retrieved Gtid Set: 0c154ad5-2699-11e8-94a1-525400eac085:309-394</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] Oldest slaves:</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]   slave1(192.168.122.70:3307)  Version=5.7.21-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]     GTID ON</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [debug]    Relay log info repository: TABLE</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]     Replicating from 192.168.122.66(192.168.122.66:3307)</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]   slave2(192.168.122.80:3307)  Version=5.7.21-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]     GTID ON</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [debug]    Relay log info repository: TABLE</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]     Replicating from 192.168.122.66(192.168.122.66:3307)</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]     Not candidate for the new Master (no_master is set)</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] </span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] * Phase 3.3: Determining New Master Phase..</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] </span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] Searching new master from slaves..</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]  Candidate masters from the configuration file:</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]   slave1(192.168.122.70:3307)  Version=5.7.21-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]     GTID ON</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [debug]    Relay log info repository: TABLE</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]     Replicating from 192.168.122.66(192.168.122.66:3307)</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]  Non-candidate masters:</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]   slave2(192.168.122.80:3307)  Version=5.7.21-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]     GTID ON</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [debug]    Relay log info repository: TABLE</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]     Replicating from 192.168.122.66(192.168.122.66:3307)</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]     Not candidate for the new Master (no_master is set)</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]  Searching from candidate_master slaves which have received the latest relay log events..</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] New master is slave1(192.168.122.70:3307)    # 选择slave1提升为新的master</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] Starting master failover..    # 开始failover切换</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] </span><br><span class="line">From:    # 原架构拓扑</span><br><span class="line">master(192.168.122.66:3307) (current master)</span><br><span class="line"> +--slave1(192.168.122.70:3307)</span><br><span class="line"> +--slave2(192.168.122.80:3307)</span><br><span class="line"></span><br><span class="line">To:		 # failover后的拓扑</span><br><span class="line">slave1(192.168.122.70:3307) (new master)</span><br><span class="line"> +--slave2(192.168.122.80:3307)</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] </span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] * Phase 3.3: New Master Recovery Phase..</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] </span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]  Waiting all logs to be applied.. </span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]   done.</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [debug]  Stopping slave IO/SQL thread on slave1(192.168.122.70:3307)..</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [debug]   done.</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] Getting new master&#x27;s binlog name and position..</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]  bin.000003:94211</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=&#x27;slave1 or 192.168.122.70&#x27;, MASTER_PORT=3307, MASTER_AUTO_POSITION=1, MASTER_USER=&#x27;rpl&#x27;, MASTER_PASSWORD=&#x27;xxx&#x27;;</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: bin.000003, 94211, 0c154ad5-2699-11e8-94a1-525400eac085:1-394,</span><br><span class="line">c08d09b5-2698-11e8-9ec0-5254004dae68:1-2</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info] Executing master IP activate script:</span><br><span class="line">Tue Mar 13 17:12:24 2018 - [info]   /usr/local/mha/bin/master_ip_failover --command=start --ssh_user=root --orig_master_host=master --orig_master_ip=192.168.122.66 --orig_master_port=3307 --new_master_host=slave1 --new_master_ip=192.168.122.70 --new_master_port=3307 --new_master_user=&#x27;root&#x27;   --new_master_password=xxx</span><br><span class="line">Unknown option: new_master_user</span><br><span class="line">Unknown option: new_master_password</span><br><span class="line"></span><br><span class="line">IN SCRIPT TEST====/sbin/ifconfig eth0:88 down==/sbin/ifconfig eth0:88 192.168.122.99/24===</span><br><span class="line"></span><br><span class="line">Enabling the VIP - 192.168.122.99/24 on the new master - slave1 </span><br><span class="line">Tue Mar 13 17:12:25 2018 - [info]  OK.</span><br><span class="line">Tue Mar 13 17:12:25 2018 - [info] ** Finished master recovery successfully.</span><br><span class="line">Tue Mar 13 17:12:25 2018 - [info] * Phase 3: Master Recovery Phase completed.</span><br><span class="line">Tue Mar 13 17:12:25 2018 - [info] </span><br><span class="line">Tue Mar 13 17:12:25 2018 - [info] * Phase 4: Slaves Recovery Phase..</span><br><span class="line">Tue Mar 13 17:12:25 2018 - [info] </span><br><span class="line">Tue Mar 13 17:12:25 2018 - [info] </span><br><span class="line">Tue Mar 13 17:12:25 2018 - [info] * Phase 4.1: Starting Slaves in parallel..</span><br><span class="line">Tue Mar 13 17:12:25 2018 - [info] </span><br><span class="line">Tue Mar 13 17:12:25 2018 - [info] -- Slave recovery on host slave2(192.168.122.80:3307) started, pid: 10212. Check tmp log /var/log/masterha/app1/slave2_3307_20180313171223.log if it takes time..</span><br><span class="line">Tue Mar 13 17:12:27 2018 - [info] </span><br><span class="line">Tue Mar 13 17:12:27 2018 - [info] Log messages from slave2 ...</span><br><span class="line">Tue Mar 13 17:12:27 2018 - [info] </span><br><span class="line">Tue Mar 13 17:12:25 2018 - [info]  Resetting slave slave2(192.168.122.80:3307) and starting replication from the new master slave1(192.168.122.70:3307)..</span><br><span class="line">Tue Mar 13 17:12:25 2018 - [debug]  Stopping slave IO/SQL thread on slave2(192.168.122.80:3307)..</span><br><span class="line">Tue Mar 13 17:12:25 2018 - [debug]   done.</span><br><span class="line">Tue Mar 13 17:12:25 2018 - [info]  Executed CHANGE MASTER.</span><br><span class="line">Tue Mar 13 17:12:25 2018 - [debug]  Starting slave IO/SQL thread on slave2(192.168.122.80:3307)..</span><br><span class="line">Tue Mar 13 17:12:26 2018 - [debug]   done.</span><br><span class="line">Tue Mar 13 17:12:26 2018 - [info]  Slave started.</span><br><span class="line">Tue Mar 13 17:12:26 2018 - [info]  gtid_wait(0c154ad5-2699-11e8-94a1-525400eac085:1-394,</span><br><span class="line">c08d09b5-2698-11e8-9ec0-5254004dae68:1-2) completed on slave2(192.168.122.80:3307). Executed 3 events.</span><br><span class="line">Tue Mar 13 17:12:27 2018 - [info] End of log messages from slave2.</span><br><span class="line">Tue Mar 13 17:12:27 2018 - [info] -- Slave on host slave2(192.168.122.80:3307) started.</span><br><span class="line">Tue Mar 13 17:12:27 2018 - [info] All new slave servers recovered successfully.</span><br><span class="line">Tue Mar 13 17:12:27 2018 - [info] </span><br><span class="line">Tue Mar 13 17:12:27 2018 - [info] * Phase 5: New master cleanup phase..</span><br><span class="line">Tue Mar 13 17:12:27 2018 - [info] </span><br><span class="line">Tue Mar 13 17:12:27 2018 - [info] Resetting slave info on the new master..</span><br><span class="line">Tue Mar 13 17:12:27 2018 - [debug]  Clearing slave info..</span><br><span class="line">Tue Mar 13 17:12:27 2018 - [debug]  Stopping slave IO/SQL thread on slave1(192.168.122.70:3307)..</span><br><span class="line">Tue Mar 13 17:12:27 2018 - [debug]   done.</span><br><span class="line">Tue Mar 13 17:12:27 2018 - [debug]  SHOW SLAVE STATUS shows new master does not replicate from anywhere. OK.</span><br><span class="line">Tue Mar 13 17:12:27 2018 - [info]  slave1: Resetting slave info succeeded.</span><br><span class="line">Tue Mar 13 17:12:27 2018 - [info] Master failover to slave1(192.168.122.70:3307) completed successfully.</span><br><span class="line">Tue Mar 13 17:12:27 2018 - [info] Deleted server1 entry from /etc/masterha/app1.conf .</span><br><span class="line">Tue Mar 13 17:12:27 2018 - [debug]  Disconnected from slave1(192.168.122.70:3307)</span><br><span class="line">Tue Mar 13 17:12:27 2018 - [debug]  Disconnected from slave2(192.168.122.80:3307)</span><br><span class="line">Tue Mar 13 17:12:27 2018 - [info] </span><br><span class="line"></span><br><span class="line">----- Failover Report -----</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下面是failover的报表，集群中master角色从原来的66:3307切到了70:3307机器</span></span><br><span class="line">app1: MySQL Master failover master(192.168.122.66:3307) to slave1(192.168.122.70:3307) succeeded</span><br><span class="line"></span><br><span class="line">Master master(192.168.122.66:3307) is down!</span><br><span class="line"></span><br><span class="line">Check MHA Manager logs at centos-66:/var/log/masterha/app1/manager.log for details.</span><br><span class="line"></span><br><span class="line">Started automated(non-interactive) failover.</span><br><span class="line">Invalidated master IP address on master(192.168.122.66:3307)</span><br><span class="line">Selected slave1(192.168.122.70:3307) as a new master.</span><br><span class="line">slave1(192.168.122.70:3307): OK: Applying all logs succeeded.</span><br><span class="line">slave1(192.168.122.70:3307): OK: Activated master IP address.</span><br><span class="line">slave2(192.168.122.80:3307): OK: Slave started, replicating from slave1(192.168.122.70:3307)</span><br><span class="line">slave1(192.168.122.70:3307): Resetting slave info succeeded.</span><br><span class="line">Master failover to slave1(192.168.122.70:3307) completed successfully.  # 切换成功</span><br></pre></td></tr></table></figure>
                </div>

                
                        
<div class="article-copyright-info-container border-box">
    <div class="copyright-info-content border-box">
        <div class="copyright-info-top border-box">
            <div class="post-title border-box text-ellipsis">
                mysql MHA 记录
            </div>

            <div class="post-link border-box text-ellipsis">
                2018/03/13/mysql-MHA-记录/
            </div>
        </div>

        <div class="copyright-info-bottom border-box">
            <div class="post-author bottom-item">
                <div class="type">
                    Author
                </div>
                <div class="content">chenzuoqing</div>
            </div>

            <div class="post-time bottom-item">
                <div class="type">
                    Published
                </div>
                <div class="content">2018-03-13 10:57</div>
            </div>


            <div class="post-license bottom-item">
                <div class="type">
                    License
                </div>
                <div class="content tooltip" data-tooltip-content="CC BY-NC-SA 4.0">
                    <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed">
                        <i class="fa-brands fa-creative-commons"></i>
                        <i class="fa-brands fa-creative-commons-by"></i>
                        <i class="fa-brands fa-creative-commons-nc"></i>
                        <i class="fa-brands fa-creative-commons-sa"></i>
                    </a>
                </div>
            </div>
        </div>

        <i class="copyright-bg fa-solid fa-copyright"></i>
    </div>
    <div class="copy-copyright-info flex-center tooltip" data-tooltip-content="Copy copyright info" data-tooltip-offset-y="-2px">
        <i class="fa-solid fa-copy"></i>
    </div>
</div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/MHA/">MHA</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                            <div class="post-share-container border-box">
    <ul class="share-list-wrap border-box">
        <li class="qq share-item border-box flex-center tooltip"
            data-tooltip-content="Share to QQ"
        >
            <i class="fa-brands fa-qq"></i>
        </li>
        <li class="wechat share-item border-box flex-center tooltip tooltip-img"
            data-tooltip-content="Share to WeChat"
            data-tooltip-img-tip="Scan by WeChat"
            data-tooltip-img-style="background-color: #fff; top: -10px; padding: 0.6rem 0.6rem 0.1rem 0.6rem;"
        >
            <i class="fa-brands fa-weixin"></i>
        </li>
        <li class="weibo share-item border-box flex-center tooltip"
            data-tooltip-content="Share to WeiBo"
        >
            <i class="fa-brands fa-weibo"></i>
        </li>
    </ul>
</div>

                        
                    </div>
                </div>

                

                
                    <div class="article-nav">
                        
                            <div class="article-prev">
                                <a class="prev"
                                   rel="prev"
                                   href="/2018/04/17/zabbix-server%E5%92%8Czabbix-proxy/"
                                   title="zabbix-server 和 zabbix-proxy"
                                >
                                    <span class="left arrow-icon flex-center">
                                      <i class="fas fa-chevron-left"></i>
                                    </span>
                                            <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">zabbix-server 和 zabbix-proxy</span>
                                        <span class="post-nav-item">Prev posts</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="article-next">
                                <a class="next"
                                   rel="next"
                                   href="/2018/03/02/mysql-router-%E4%B8%AD%E9%97%B4%E4%BB%B6%E4%BD%93%E9%AA%8C/"
                                   title="mysql router 中间件体验"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">mysql router 中间件体验</span>
                                        <span class="post-nav-item">Next posts</span>
                                    </span>
                                            <span class="right arrow-icon flex-center">
                                      <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    






                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#MySQL-MHA%E9%85%8D%E7%BD%AE%E8%AE%B0%E5%BD%95"><span class="nav-text">MySQL MHA配置记录</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#MHA%E4%BB%8B%E7%BB%8D"><span class="nav-text">MHA介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9%E6%8F%8F%E8%BF%B0"><span class="nav-text">集群节点描述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%85%E9%9A%9C%E6%A3%80%E6%B5%8B%E8%BF%87%E7%A8%8B"><span class="nav-text">故障检测过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MHA-Failover%E8%BF%87%E7%A8%8B"><span class="nav-text">MHA Failover过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F"><span class="nav-text">注意</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-text">准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E9%9B%86%E7%BE%A4%E6%8B%93%E6%89%91%E5%9B%BE"><span class="nav-text">测试集群拓扑图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MHA%E8%BD%AF%E4%BB%B6%E8%A7%92%E8%89%B2%E5%88%86%E5%B8%83"><span class="nav-text">MHA软件角色分布</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85MHA%E8%BD%AF%E4%BB%B6"><span class="nav-text">安装MHA软件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96MHA%E6%BA%90%E7%A0%81"><span class="nav-text">获取MHA源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%B8%8A%E5%87%86%E5%A4%87%E4%B8%BB%E4%BB%8E%EF%BC%8Cmysqlreplicate%E6%90%AD%E5%BB%BA%EF%BC%8C%E4%B8%8D%E6%BC%94%E7%A4%BA%E3%80%82"><span class="nav-text">如上准备主从，mysqlreplicate搭建，不演示。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96%E5%8C%85"><span class="nav-text">安装依赖包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85MHA-Manager"><span class="nav-text">安装MHA Manager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85MHA-node"><span class="nav-text">安装MHA node</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MHA%E8%87%AA%E5%B8%A6%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-text">MHA自带配置文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MHA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%92%8C%E8%84%9A%E6%9C%AC"><span class="nav-text">MHA配置文件和脚本</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%BB%86%E8%BF%B0"><span class="nav-text">示例配置文件细述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#failover%E8%84%9A%E6%9C%AC"><span class="nav-text">failover脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E7%BA%BF%E5%88%87%E6%8D%A2master%E7%9A%84%E8%84%9A%E6%9C%AC"><span class="nav-text">在线切换master的脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Slave%E4%B8%8A%E7%9A%84relay-log%E9%85%8D%E7%BD%AE"><span class="nav-text">Slave上的relay_log配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pure-relay-logs%E5%B7%A5%E5%85%B7"><span class="nav-text">pure_relay_logs工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Manager%E6%A3%80%E6%B5%8B%E9%85%8D%E7%BD%AE%E4%B8%AD%E4%B8%BB%E6%9C%BA%E7%8A%B6%E6%80%81"><span class="nav-text">Manager检测配置中主机状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8MHA"><span class="nav-text">启动MHA</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BAmaster%E6%B7%BB%E5%8A%A0%E6%B5%AE%E5%8A%A8ip"><span class="nav-text">为master添加浮动ip</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8masterha-manager"><span class="nav-text">启动masterha_manager</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95MHA%E8%87%AA%E5%8A%A8Failover"><span class="nav-text">测试MHA自动Failover</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="border-box website-info-box default">
        
            <div class="copyright-info info-item default">
                &copy;&nbsp;<span>2017</span>&nbsp;-&nbsp;2023
                
                    &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">chenzuoqing</a>
                
            </div>

            <div class="theme-info info-item default">
                Powered by&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;&&nbsp;Theme&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
            </div>

            
                <div class="icp-info info-item default">
                    <a class=""
                       target="_blank"
                       href="https://beian.miit.gov.cn"
                    >
                        赣ICP备16002857号-1
                    </a>
                </div>
            

            
        

        <div class="count-item info-item default">
            

            
                <span class="count-box border-box uv">
                    <span class="item-type border-box">Unique Visitor</span>
                    <span class="item-value border-box uv" id="busuanzi_value_site_uv"></span>
                </span>
            

            
                <span class="count-box border-box pv">
                    <span class="item-type border-box">Page View</span>
                    <span class="item-value border-box pv" id="busuanzi_value_site_pv"></span>
                </span>
            
        </div>
    </div>
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="tools-list border-box">
        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#MySQL-MHA%E9%85%8D%E7%BD%AE%E8%AE%B0%E5%BD%95"><span class="nav-text">MySQL MHA配置记录</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#MHA%E4%BB%8B%E7%BB%8D"><span class="nav-text">MHA介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9%E6%8F%8F%E8%BF%B0"><span class="nav-text">集群节点描述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%85%E9%9A%9C%E6%A3%80%E6%B5%8B%E8%BF%87%E7%A8%8B"><span class="nav-text">故障检测过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MHA-Failover%E8%BF%87%E7%A8%8B"><span class="nav-text">MHA Failover过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F"><span class="nav-text">注意</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-text">准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E9%9B%86%E7%BE%A4%E6%8B%93%E6%89%91%E5%9B%BE"><span class="nav-text">测试集群拓扑图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MHA%E8%BD%AF%E4%BB%B6%E8%A7%92%E8%89%B2%E5%88%86%E5%B8%83"><span class="nav-text">MHA软件角色分布</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85MHA%E8%BD%AF%E4%BB%B6"><span class="nav-text">安装MHA软件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96MHA%E6%BA%90%E7%A0%81"><span class="nav-text">获取MHA源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%B8%8A%E5%87%86%E5%A4%87%E4%B8%BB%E4%BB%8E%EF%BC%8Cmysqlreplicate%E6%90%AD%E5%BB%BA%EF%BC%8C%E4%B8%8D%E6%BC%94%E7%A4%BA%E3%80%82"><span class="nav-text">如上准备主从，mysqlreplicate搭建，不演示。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96%E5%8C%85"><span class="nav-text">安装依赖包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85MHA-Manager"><span class="nav-text">安装MHA Manager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85MHA-node"><span class="nav-text">安装MHA node</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MHA%E8%87%AA%E5%B8%A6%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-text">MHA自带配置文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MHA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%92%8C%E8%84%9A%E6%9C%AC"><span class="nav-text">MHA配置文件和脚本</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%BB%86%E8%BF%B0"><span class="nav-text">示例配置文件细述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#failover%E8%84%9A%E6%9C%AC"><span class="nav-text">failover脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E7%BA%BF%E5%88%87%E6%8D%A2master%E7%9A%84%E8%84%9A%E6%9C%AC"><span class="nav-text">在线切换master的脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Slave%E4%B8%8A%E7%9A%84relay-log%E9%85%8D%E7%BD%AE"><span class="nav-text">Slave上的relay_log配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pure-relay-logs%E5%B7%A5%E5%85%B7"><span class="nav-text">pure_relay_logs工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Manager%E6%A3%80%E6%B5%8B%E9%85%8D%E7%BD%AE%E4%B8%AD%E4%B8%BB%E6%9C%BA%E7%8A%B6%E6%80%81"><span class="nav-text">Manager检测配置中主机状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8MHA"><span class="nav-text">启动MHA</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BAmaster%E6%B7%BB%E5%8A%A0%E6%B5%AE%E5%8A%A8ip"><span class="nav-text">为master添加浮动ip</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8masterha-manager"><span class="nav-text">启动masterha_manager</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95MHA%E8%87%AA%E5%8A%A8Failover"><span class="nav-text">测试MHA自动Failover</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>



<!-- common -->

<script src="/js/utils.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>

<script src="/js/main.js"></script>

<script src="/js/libs/anime.min.js"></script>


<!-- local-search -->

    
<script src="/js/local-search.js"></script>



<!-- code-block -->

    
<script src="/js/code-block.js"></script>



<!-- lazyload -->

    
<script src="/js/lazyload.js"></script>



<div class="">
    
        <!-- post-helper -->
        
<script src="/js/post/post-helper.js"></script>


        <!-- toc -->
        
            
<script src="/js/post/toc.js"></script>

        

        <!-- copyright-info -->
        
            
<script src="/js/post/copyright-info.js"></script>

        

        <!-- share -->
        
            
<script src="/js/post/share.js"></script>

        
    

    <!-- category-page -->
    

    <!-- links-page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



    

</body>
</html>
